# SwinIR for Bubble Occlusion Reconstruction
# åŸºäºSwinIRçš„æ°”æ³¡é®æŒ¡åŒºåŸŸé‡å»ºç³»ç»Ÿ

[![Original SwinIR](https://img.shields.io/badge/Based%20on-SwinIR-blue)](https://github.com/JingyunLiang/SwinIR)
[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![PyTorch 1.10+](https://img.shields.io/badge/pytorch-1.10+-orange.svg)](https://pytorch.org/)
[![License](https://img.shields.io/badge/license-Apache%202.0-green.svg)](LICENSE)

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ ¸å¿ƒæ”¹è¿›](#æ ¸å¿ƒæ”¹è¿›)
   - [è¯¾ç¨‹å­¦ä¹ ](#1-è¯¾ç¨‹å­¦ä¹ curriculum-learning)
   - [Deepfillv2æ•°æ®æ ¼å¼](#2-ç›´æ¥ä½¿ç”¨deepfillv2æ•°æ®æ ¼å¼)
   - [å®Œæ•´è¯„ä¼°ä½“ç³»](#3-å®Œæ•´è¯„ä¼°ä½“ç³»)
   - [å¤šGPUå¹¶è¡Œè®­ç»ƒ](#4-å¤šgpuå¹¶è¡Œè®­ç»ƒæ–°å¢-2025-11-19)
   - [å®æ—¶è®­ç»ƒè¿›åº¦](#5-å®æ—¶è®­ç»ƒè¿›åº¦æ˜¾ç¤ºæ–°å¢-2025-11-19)
   - [è®­ç»ƒæ›²çº¿å¯è§†åŒ–](#6-è®­ç»ƒæ›²çº¿å¯è§†åŒ–æ–°å¢-2025-11-19)
   - [æ—¶é—´æˆ³å®éªŒç®¡ç†](#7-æ—¶é—´æˆ³å®éªŒç®¡ç†)
   - [å¢å¼ºçš„æŸå¤±å‡½æ•°](#8-å¢å¼ºçš„æŸå¤±å‡½æ•°ç³»ç»Ÿæ–°å¢-2025-11-19)
   - [å¯æ§çš„æ®‹å·®è¿æ¥](#9-å¯æ§çš„æ®‹å·®è¿æ¥æ–°å¢-2025-11-20)
3. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
4. [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
5. [æ–‡ä»¶ç»“æ„](#æ–‡ä»¶ç»“æ„)
6. [è¯¦ç»†æ–‡æ¡£](#è¯¦ç»†æ–‡æ¡£)
7. [æ€§èƒ½å¯¹æ¯”](#æ€§èƒ½å¯¹æ¯”)
8. [åŸå§‹SwinIR](#åŸå§‹swinir)

---

## ğŸ“– é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®åŸºäº**SwinIR (ICCV 2021)** [Image Restoration Using Swin Transformer](https://github.com/JingyunLiang/SwinIR)ï¼Œé’ˆå¯¹**æ°”æ³¡é®æŒ¡åŒºåŸŸé‡å»ºä»»åŠ¡**è¿›è¡Œäº†æ·±åº¦å®šåˆ¶å’Œä¼˜åŒ–ã€‚

### ä»»åŠ¡å®šä¹‰

- **è¾“å…¥**: è¢«å…¶ä»–æ°”æ³¡é®æŒ¡çš„æ°”æ³¡ç°‡å›¾åƒï¼ˆBlocked Imageï¼‰
- **è¾“å‡º**: å®Œæ•´çš„å•ä¸ªæ°”æ³¡å›¾åƒï¼ˆOrigin Imageï¼‰
- **å…³é”®æŒ‘æˆ˜**: ä¸åŒé®æŒ¡ç¨‹åº¦ï¼ˆ0-100%ï¼‰çš„é‡å»º

### ä¸åŸå§‹SwinIRçš„åŒºåˆ«

| ç»´åº¦ | åŸå§‹SwinIR | æœ¬é¡¹ç›® |
|------|-----------|--------|
| **ä»»åŠ¡ç±»å‹** | å›¾åƒè¶…åˆ†è¾¨ç‡ã€å»å™ªã€å»ä¼ªå½± | æ°”æ³¡é®æŒ¡åŒºåŸŸé‡å»º |
| **æ•°æ®æ ¼å¼** | æ ‡å‡†å›¾åƒå¯¹ï¼ˆLR/HRï¼‰ | Deepfillv2æ ¼å¼ï¼ˆBlocked/Mask/Originï¼‰ |
| **è®­ç»ƒç­–ç•¥** | æ ‡å‡†ç›‘ç£å­¦ä¹  | **è¯¾ç¨‹å­¦ä¹ **ï¼ˆé®æŒ¡ç¨‹åº¦æ¸è¿›å¼è®­ç»ƒï¼‰ |
| **è¯„ä¼°ä½“ç³»** | åŸºç¡€PSNR/SSIM | **å¤šç»´åº¦è¯„ä¼°**ï¼ˆL1/MSE/PSNR/SSIM + å¯è§†åŒ–ï¼‰ |
| **GPUæ”¯æŒ** | å•GPU | **å¤šGPUå¹¶è¡Œè®­ç»ƒ**ï¼ˆDataParallelï¼‰ |
| **è¿›åº¦ç›‘æ§** | ç®€å•è¿›åº¦æ¡ | **å®æ—¶è¯¦ç»†è¿›åº¦** + è®­ç»ƒæ›²çº¿å¯è§†åŒ– |
| **æ•°æ®å¢å¼º** | æ—  | æ”¯æŒç¿»è½¬ã€æ—‹è½¬ç­‰å¢å¼º |
| **å®éªŒç®¡ç†** | æ‰‹åŠ¨ç®¡ç† | **æ—¶é—´æˆ³è‡ªåŠ¨ç®¡ç†** + å®Œæ•´é…ç½®è®°å½• |

---

## ğŸš€ æ ¸å¿ƒæ”¹è¿›

### 1. âœ¨ è¯¾ç¨‹å­¦ä¹ ï¼ˆCurriculum Learningï¼‰

ä»Deepfillv2ç»§æ‰¿çš„æ ¸å¿ƒè®­ç»ƒç­–ç•¥ï¼Œ**ä»ç®€å•åˆ°å›°éš¾**é€æ­¥è®­ç»ƒæ¨¡å‹ã€‚

```python
# è¯¾ç¨‹å­¦ä¹ ç¤ºä¾‹ï¼ˆé»˜è®¤æ¯10ä¸ªepochå¢åŠ ä¸€ä¸ªé®æŒ¡ç±»åˆ«ï¼‰
Epoch 1-10:    ä½¿ç”¨ ['0-10']                    # æœ€ä½é®æŒ¡ï¼ˆæœ€ç®€å•ï¼‰
Epoch 11-20:   ä½¿ç”¨ ['0-10', '10-20']
Epoch 21-30:   ä½¿ç”¨ ['0-10', '10-20', '20-30']
...
Epoch 91-500:  ä½¿ç”¨æ‰€æœ‰ç±»åˆ«                      # å…¨éƒ¨éš¾åº¦
```

**ä¼˜åŠ¿**:
- æ›´å¿«æ”¶æ•›
- æ›´å¥½çš„æ³›åŒ–æ€§èƒ½
- é¿å…è®­ç»ƒåˆæœŸè¢«å›°éš¾æ ·æœ¬å¹²æ‰°

### 2. ğŸ¯ ç›´æ¥ä½¿ç”¨Deepfillv2æ•°æ®æ ¼å¼

**æ— éœ€æ•°æ®è½¬æ¢**ï¼Œç›´æ¥è¯»å–ç°æœ‰æ•°æ®é›†ã€‚

```
dataset_overlap/
â”œâ”€â”€ training_dataset20251111/
â”‚   â”œâ”€â”€ 0-10/              # é®æŒ¡ç¨‹åº¦åˆ†ç±»
â”‚   â”‚   â”œâ”€â”€ Blocked/       # è¾“å…¥ï¼šè¢«é®æŒ¡çš„æ°”æ³¡ç°‡
â”‚   â”‚   â”œâ”€â”€ Mask/          # ï¼ˆå­˜åœ¨ä½†SwinIRä¸ä½¿ç”¨ï¼‰
â”‚   â”‚   â””â”€â”€ Origin/        # ç›®æ ‡ï¼šå®Œæ•´çš„å•æ°”æ³¡
â”‚   â”œâ”€â”€ 10-20/
â”‚   â””â”€â”€ ...
```

**å…³é”®ç‰¹æ€§**:
- è‡ªåŠ¨å‘ç°æ‰€æœ‰é®æŒ¡ç±»åˆ«
- æ”¯æŒ`filtered_dataset()`æ–¹æ³•å®ç°è¯¾ç¨‹å­¦ä¹ 
- LRUç¼“å­˜ä¼˜åŒ–åŠ è½½é€Ÿåº¦

### 3. ğŸ“Š å®Œæ•´è¯„ä¼°ä½“ç³»

**4é¡¹æ ¸å¿ƒæŒ‡æ ‡** + **3ä¸ªæ•°æ®é›†** + **å¯è§†åŒ–**ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | ç›®æ ‡å€¼ |
|------|------|--------|
| **L1 Loss** | å¹³å‡ç»å¯¹è¯¯å·® | â†“ è¶Šä½è¶Šå¥½ |
| **MSE** | å‡æ–¹è¯¯å·® | â†“ è¶Šä½è¶Šå¥½ |
| **PSNR** | å³°å€¼ä¿¡å™ªæ¯” | â†‘ >28dB è¾ƒå¥½ï¼Œ>30dB ä¼˜ç§€ |
| **SSIM** | ç»“æ„ç›¸ä¼¼æ€§ | â†‘ >0.85 è¾ƒå¥½ï¼Œ>0.90 ä¼˜ç§€ |

**è¯„ä¼°æµç¨‹**:
- è®­ç»ƒé›†ï¼šæ¯ä¸ªepochè®¡ç®—å¹³å‡æŒ‡æ ‡
- éªŒè¯é›†ï¼šæ¯ä¸ªepochè¯„ä¼°ï¼ˆæ— å¯è§†åŒ–ï¼‰
- æµ‹è¯•é›†ï¼šæ¯éš”Nä¸ªepochè¯„ä¼°ï¼ˆä¿å­˜å¯è§†åŒ–ï¼‰

### 4. ğŸ–¥ï¸ å¤šGPUå¹¶è¡Œè®­ç»ƒï¼ˆæ–°å¢ 2025-11-19ï¼‰

ä½¿ç”¨`nn.DataParallel`å®ç°é«˜æ•ˆå¤šGPUè®­ç»ƒã€‚

```bash
# è‡ªåŠ¨ä½¿ç”¨GPU 2å’Œ3
python train_bubble_swinir.py --multi_gpu True --gpu_ids "2,3"
```

**è‡ªåŠ¨ä¼˜åŒ–**:
- Batch sizeè‡ªåŠ¨ä¹˜ä»¥GPUæ•°é‡ï¼ˆ16 â†’ 32 for 2 GPUsï¼‰
- Num workersè‡ªåŠ¨è°ƒæ•´ï¼ˆ4 â†’ 8 for 2 GPUsï¼‰
- æ­£ç¡®å¤„ç†checkpointä¿å­˜å’ŒåŠ è½½

**æ€§èƒ½æå‡**:
- 2 GPU: ~1.85xåŠ é€Ÿ
- 4 GPU: ~3.5xåŠ é€Ÿ

### 5. ğŸ“ˆ å®æ—¶è®­ç»ƒè¿›åº¦æ˜¾ç¤ºï¼ˆæ–°å¢ 2025-11-19ï¼‰

æ¯ä¸ªiterationå®æ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼š

```
[Train] Epoch 10/500 â€¢ Batch 15/128 â€¢ Time 14:35:22
  Loss: L1 0.12345 | Percep 0.02345
  Quality: PSNR 26.54 dB | MSE 0.00234 | SSIM 0.856
  Categories: 2 active: 0-10, 10-20
  Timing: 0.234s/batch | ETA: 2:15:30
```

**åŒ…å«ä¿¡æ¯**:
- â° å½“å‰æ—¶é—´ã€epoch/batchè¿›åº¦
- ğŸ“‰ å®æ—¶æŸå¤±å’ŒæŒ‡æ ‡
- ğŸ“š æ¿€æ´»çš„è¯¾ç¨‹å­¦ä¹ ç±»åˆ«
- â±ï¸ æ‰¹å¤„ç†ç”¨æ—¶å’ŒETAï¼ˆé¢„è®¡å‰©ä½™æ—¶é—´ï¼‰

### 6. ğŸ“Š è®­ç»ƒæ›²çº¿å¯è§†åŒ–ï¼ˆæ–°å¢ 2025-11-19ï¼‰

è‡ªåŠ¨ç”Ÿæˆ`training_curves.png`ï¼ŒåŒ…å«4ä¸ªå­å›¾ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Loss (L1)     â”‚   PSNR (dB)     â”‚
â”‚  Train/Val/Test â”‚  Train/Val/Test â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   SSIM          â”‚   MSE           â”‚
â”‚  Train/Val/Test â”‚  Train/Val/Test â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹æ€§**:
- å®æ—¶æ›´æ–°ï¼ˆæ¯éš”eval_intervalï¼‰
- ä¸‰æ¡æ›²çº¿å¯¹æ¯”ï¼ˆTrain/Val/Testï¼‰
- é«˜åˆ†è¾¨ç‡è¾“å‡ºï¼ˆ150 DPIï¼‰
- è‡ªåŠ¨è¿‡æ»¤Noneå€¼

### 7. ğŸ—‚ï¸ æ—¶é—´æˆ³å®éªŒç®¡ç†

æ¯æ¬¡è®­ç»ƒè‡ªåŠ¨åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„å®éªŒæ–‡ä»¶å¤¹ï¼š

```
experiments/20251119_143025/
â”œâ”€â”€ config.txt                    # å®Œæ•´è®­ç»ƒé…ç½®
â”œâ”€â”€ training_curves.png           # è®­ç»ƒæ›²çº¿ï¼ˆå®æ—¶æ›´æ–°ï¼‰
â”œâ”€â”€ checkpoints/
â”‚   â”œâ”€â”€ epoch_0005.pth           # å®šæœŸä¿å­˜
â”‚   â”œâ”€â”€ epoch_0010.pth
â”‚   â””â”€â”€ best_model.pth           # æœ€ä½³æ¨¡å‹
â”œâ”€â”€ visualizations/
â”‚   â”œâ”€â”€ epoch_0005/              # æµ‹è¯•é›†å¯è§†åŒ–
â”‚   â”‚   â”œâ”€â”€ test_001.png
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ epoch_0010/
â””â”€â”€ logs/
    â”œâ”€â”€ events.out.tfevents...   # TensorBoardæ—¥å¿—
    â””â”€â”€ Train_Iter/              # iterationçº§åˆ«æŒ‡æ ‡
```

### 8. ğŸ¯ å¢å¼ºçš„æŸå¤±å‡½æ•°ç³»ç»Ÿï¼ˆæ–°å¢ 2025-11-19ï¼‰

é’ˆå¯¹**æ°”æ³¡ç°‡â†’å•æ°”æ³¡**çš„å†…å®¹è½¬æ¢ä»»åŠ¡ï¼Œæ–°å¢ä¸“é—¨çš„æŸå¤±å‡½æ•°çº¦æŸã€‚

#### æ ¸å¿ƒé—®é¢˜åˆ†æ

åŸå§‹SwinIRä»…ä½¿ç”¨L1/L2æŸå¤±ï¼Œæ— æ³•å¼•å¯¼æ¨¡å‹ï¼š
- âŒ ç”Ÿæˆæ¸…æ™°çš„å•æ°”æ³¡è½®å»“
- âŒ æ¶ˆé™¤å¤šä½™çš„æ°”æ³¡ç»“æ„
- âŒ ä¿æŒè¾¹ç¼˜é”åˆ©åº¦

#### æ–°å¢æŸå¤±å‡½æ•°

| æŸå¤±å‡½æ•° | ä½œç”¨ | æ¨èæƒé‡ | ä¼˜å…ˆçº§ |
|---------|------|---------|--------|
| **EdgeLoss** | å¼•å¯¼ç”Ÿæˆæ¸…æ™°çš„å•æ°”æ³¡è½®å»“ | 5.0-10.0 | â­â­â­â­â­ |
| **SSIMLoss** | ä¿æŒç»“æ„ç›¸ä¼¼æ€§ | 1.0-2.0 | â­â­â­â­â­ |
| **GradientLoss** | ä¿æŒè¾¹ç¼˜é”åˆ©åº¦ | 2.0-5.0 | â­â­â­â­ |
| L1 Loss | åƒç´ çº§çº¦æŸï¼ˆåŸæœ‰ï¼‰ | 1.0 | â­â­â­â­ |
| Perceptual Loss | é«˜å±‚è¯­ä¹‰ï¼ˆåŸæœ‰ï¼‰ | 0.1 | â­â­â­ |

#### EdgeLossï¼ˆè¾¹ç¼˜æŸå¤±ï¼‰

```python
# ä½¿ç”¨Sobelç®—å­æå–è¾¹ç¼˜
pred_edges = sobel(pred_img)
target_edges = sobel(target_img)
loss_edge = MSE(pred_edges, target_edges)
```

**æ•ˆæœ**: å¼ºåˆ¶æ¨¡å‹ç”Ÿæˆä¸ç›®æ ‡ä¸€è‡´çš„å•æ°”æ³¡è½®å»“

#### SSIMLossï¼ˆç»“æ„ç›¸ä¼¼æ€§æŸå¤±ï¼‰

```python
# å®šä¹‰ä¸º 1 - SSIM
loss_ssim = 1 - SSIM(pred_img, target_img)
```

**æ•ˆæœ**: ä¿æŒæ•´ä½“ç»“æ„ä¸€è‡´æ€§ï¼Œé¿å…ç”Ÿæˆæ‰­æ›²çš„å½¢çŠ¶

#### GradientLossï¼ˆæ¢¯åº¦æŸå¤±ï¼‰

```python
# è®¡ç®—xå’Œyæ–¹å‘çš„æ¢¯åº¦
pred_grad_x = pred[:, :, :, 1:] - pred[:, :, :, :-1]
target_grad_x = target[:, :, :, 1:] - target[:, :, :, :-1]
loss_grad = L1(pred_grad_x, target_grad_x) + L1(pred_grad_y, target_grad_y)
```

**æ•ˆæœ**: ä¿æŒè¾¹ç¼˜çš„é”åˆ©åº¦å’Œæ¸…æ™°åº¦

#### ä½¿ç”¨æ–¹æ³•

```bash
python train_bubble_swinir.py \
    --lambda_l1 1.0 \
    --lambda_edge 10.0 \        # â† å¼ºè¾¹ç¼˜çº¦æŸ
    --lambda_ssim 1.0 \         # â† ç»“æ„çº¦æŸ
    --lambda_gradient 5.0 \     # â† æ¢¯åº¦çº¦æŸ
    --lambda_perceptual 0.1 \
    --edge_method sobel         # sobel æˆ– canny
```

### 9. ğŸ”§ å¯æ§çš„æ®‹å·®è¿æ¥ï¼ˆæ–°å¢ 2025-11-20ï¼‰

è§£å†³SwinIRæ¶æ„ä¸é€‚åˆå†…å®¹è½¬æ¢ä»»åŠ¡çš„æ ¸å¿ƒé—®é¢˜ã€‚

#### æ ¸å¿ƒé—®é¢˜ï¼šæ®‹å·®è¿æ¥å¼ºåˆ¶ä¿ç•™è¾“å…¥

**åŸå§‹SwinIRè®¾è®¡**ï¼ˆé€‚åˆå»å™ª/è¶…åˆ†è¾¨ç‡ï¼‰:
```python
# ä¸¤å±‚æ®‹å·®è¿æ¥éƒ½å›ºå®šä¸º1.0ï¼Œå¼ºåˆ¶ä¿ç•™åŸå§‹ä¿¡æ¯
res = conv_after_body(features) + 1.0 * x_first  # ç‰¹å¾çº§
output = 1.0 * conv_last(res) + x                 # å›¾åƒçº§
```

**é—®é¢˜**: å¯¹äºæ°”æ³¡ç°‡â†’å•æ°”æ³¡çš„å†…å®¹è½¬æ¢ä»»åŠ¡ï¼š
```
è¾“å…¥ï¼š[æ°”æ³¡ç°‡å›¾åƒ]
æœŸæœ›è¾“å‡ºï¼š[å•æ°”æ³¡å›¾åƒ]
å®é™…è¾“å‡ºï¼šæ¨¡å‹å­¦ä¹ ç»“æœ + åŸå§‹æ°”æ³¡ç°‡ = [æ··ä¹±çš„å åŠ ] âŒ
è®­ç»ƒç°è±¡ï¼šè¾“å‡ºå‡ ä¹ç­‰äºè¾“å…¥ï¼ŒæŸå¤±ä¸ä¸‹é™
```

#### è§£å†³æ–¹æ¡ˆï¼šæ¸è¿›å¼æ®‹å·®å¼ºåº¦æ§åˆ¶

**è®¾è®¡ç†å¿µ**ï¼š"**è¶Šé è¿‘æ¨¡å‹è¾“å…¥è¾“å‡ºï¼Œæ®‹å·®è¿æ¥æ¯”ä¾‹è¶Šå°**"

æ–°å¢ä¸¤ä¸ªå¯è°ƒå‚æ•°ï¼Œç°å·²ä½œä¸ºå‘½ä»¤è¡Œè¶…å‚æ•°ï¼š

| å‚æ•° | æ§åˆ¶å¯¹è±¡ | ä½ç½® | é»˜è®¤å€¼ | æ¨èèŒƒå›´ | è¯´æ˜ |
|------|---------|------|--------|---------|------|
| `shallow_residual_scale` | **åŸå§‹è¾“å…¥ `x`** | å›¾åƒçº§ï¼ˆæœ€æµ…å±‚ï¼‰ | 0.1 | 0.0-0.2 | æœ€æ¥è¿‘è¾“å…¥è¾“å‡ºï¼Œä¿ç•™**æœ€å°‘** |
| `residual_scale` | **æµ…å±‚ç‰¹å¾ `x_first`** | ç‰¹å¾çº§ï¼ˆè¾ƒæ·±å±‚ï¼‰ | 0.5 | 0.3-0.8 | è·ç¦»è¾“å…¥è¾ƒè¿œï¼Œå¯ä¿ç•™**è¾ƒå¤š** |

#### ä¿®æ”¹åçš„forwardæµç¨‹

```python
# åŸå§‹è®¾è®¡ï¼ˆé—®é¢˜ä»£ç ï¼‰ï¼š
res = conv_after_body(forward_features(x_first)) + shallow_residual_scale * x_first  # âŒ è¯­ä¹‰æ··ä¹±
output = x + residual_scale * conv_last(res)                                          # âŒ å‚æ•°åäº†

# é‡æ–°è®¾è®¡ï¼ˆæ­£ç¡®é€»è¾‘ï¼‰ï¼š
# ç‰¹å¾çº§æ®‹å·®ï¼šä¿ç•™50%ç‰¹å¾ä¿¡æ¯ï¼ˆè¾ƒæ·±å±‚ï¼Œå¯ä»¥å¤šä¿ç•™ï¼‰
res = conv_after_body(forward_features(x_first)) + 0.5 * x_first

# å›¾åƒçº§æ®‹å·®ï¼šåªä¿ç•™10%åŸå§‹è¾“å…¥ï¼ˆæœ€æµ…å±‚ï¼Œä¿ç•™æœ€å°‘ï¼‰
output = conv_last(res) + 0.1 * x
```

**å…³é”®æ”¹åŠ¨**ï¼š
1. âœ… ç»Ÿä¸€é€»è¾‘ï¼šæ®‹å·®ç³»æ•°éƒ½ä½œç”¨åœ¨"æ—§çš„/è¾“å…¥"ä¸Šï¼Œè€Œé"æ–°çš„/è¾“å‡º"
2. âœ… æ­£ç¡®è¯­ä¹‰ï¼š`shallow_residual_scale`æ§åˆ¶æœ€æµ…çš„`x`ï¼Œ`residual_scale`æ§åˆ¶è¾ƒæ·±çš„`x_first`
3. âœ… æ¸è¿›ç­–ç•¥ï¼šè¶Šé è¿‘è¾“å…¥è¾“å‡ºï¼Œä¿ç•™æ¯”ä¾‹è¶Šå°

**æ•ˆæœå¯¹æ¯”**:
```
ä¿®æ”¹å‰ï¼ˆresidual_scale=1.0, shallow_residual_scale=1.0ï¼‰ï¼š
  â†’ è¾“å‡º â‰ˆ è¾“å…¥ï¼Œæ¨¡å‹æ— æ³•å­¦ä¹ 

ä¿®æ”¹åï¼ˆresidual_scale=0.5, shallow_residual_scale=0.1ï¼‰ï¼š
  â†’ è¾“å‡ºä¸»è¦æ¥è‡ªæ¨¡å‹å­¦ä¹ ï¼Œå°‘é‡ä¿ç•™åŸå§‹ç»†èŠ‚ âœ…
```

#### æ•°æ®æµå¯è§†åŒ–

```
è¾“å…¥ x (åŸå§‹æ°”æ³¡ç°‡) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                      â”‚
   conv_first                                  â”‚
        â†“                                      â”‚
   x_first (æµ…å±‚ç‰¹å¾) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
        â†“                        â”‚             â”‚
   forward_features             â”‚ 0.5Ã—        â”‚ 0.1Ã—
   (æ·±åº¦Transformer)            â”‚ (è¾ƒå¤š)      â”‚ (æœ€å°‘)
        â†“                        â”‚             â”‚
   conv_after_body              â”‚             â”‚
        â†“                        â”‚             â”‚
   æ·±åº¦å¤„ç†ç»“æœ â”€â”€â”€â”€â”€(+)â”€â”€â”€â”€â”€> res           â”‚
                                 â†“             â”‚
                            conv_last          â”‚
                                 â†“             â”‚
                          æ¨¡å‹æœ€ç»ˆè¾“å‡º â”€(+)â”€> output
```

#### ä½¿ç”¨æ–¹æ³•ï¼ˆå·²ä½œä¸ºè¶…å‚æ•°ï¼‰

```bash
# æ–¹å¼1ï¼šä½¿ç”¨é»˜è®¤æ¨èé…ç½®ï¼ˆå›¾åƒä¿®å¤ä»»åŠ¡ï¼‰
python train_bubble_swinir.py \
    --residual_scale 0.5 \          # ç‰¹å¾çº§ä¿ç•™50%
    --shallow_residual_scale 0.1    # å›¾åƒçº§ä¿ç•™10%

# æ–¹å¼2ï¼šæ¿€è¿›ä¿®å¤ï¼ˆå®Œå…¨ä¾èµ–æ¨¡å‹å­¦ä¹ ï¼‰
python train_bubble_swinir.py \
    --residual_scale 0.3 \          # ç‰¹å¾çº§ä¿ç•™30%
    --shallow_residual_scale 0.0    # å›¾åƒçº§å®Œå…¨ç§»é™¤

# æ–¹å¼3ï¼šä¿å®ˆä¿®å¤ï¼ˆä¿ç•™æ›´å¤šåŸå§‹ä¿¡æ¯ï¼Œé€‚åˆè®­ç»ƒä¸ç¨³å®šæ—¶ï¼‰
python train_bubble_swinir.py \
    --residual_scale 0.8 \          # ç‰¹å¾çº§ä¿ç•™80%
    --shallow_residual_scale 0.2    # å›¾åƒçº§ä¿ç•™20%
```

è®­ç»ƒå¯åŠ¨æ—¶ä¼šæ˜¾ç¤ºï¼š
```
æ®‹å·®è¿æ¥é…ç½®:
  Feature-level residual (æ§åˆ¶x_first): 0.5 (è¾ƒæ·±å±‚)
  Image-level residual (æ§åˆ¶x): 0.1 (æœ€æµ…å±‚)
  â†’ è¶Šé è¿‘è¾“å…¥è¾“å‡ºï¼Œæ®‹å·®æ¯”ä¾‹è¶Šå°ï¼Œè¿«ä½¿æ¨¡å‹å­¦ä¹ ä¿®å¤å†…å®¹
```

#### å®éªŒå»ºè®®

**è°ƒå‚ç­–ç•¥**ï¼š
1. **èµ·å§‹é…ç½®**ï¼šä½¿ç”¨é»˜è®¤å€¼ `0.5, 0.1`
2. **è‹¥è¾“å‡ºä»æ¥è¿‘è¾“å…¥**ï¼šé™ä½ `shallow_residual_scale` åˆ° `0.0`
3. **è‹¥è®­ç»ƒä¸ç¨³å®š/æŸå¤±éœ‡è¡**ï¼šæé«˜ä¸¤ä¸ªå‚æ•°ï¼Œå¦‚ `0.7, 0.2`
4. **è‹¥æƒ³è¦æ›´æ¿€è¿›çš„ä¿®å¤**ï¼šé™ä½ä¸¤ä¸ªå‚æ•°ï¼Œå¦‚ `0.3, 0.0`

**åˆ¤æ–­æ ‡å‡†**ï¼š
- âœ… å¥½çš„ä¿¡å·ï¼šæŸå¤±æŒç»­ä¸‹é™ï¼Œè¾“å‡ºä¸è¾“å…¥æ˜æ˜¾ä¸åŒ
- âŒ åçš„ä¿¡å·ï¼šæŸå¤±ä¸å˜ï¼Œè¾“å‡ºå‡ ä¹å¤åˆ¶è¾“å…¥

---

## âš¡ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå®‰è£…

```bash
# å…‹éš†ä»“åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
git clone <your-repo-url>
cd SwinIR

# å®‰è£…ä¾èµ–
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
pip install opencv-python numpy scikit-image tqdm tensorboard matplotlib
```

### 2. éªŒè¯å®ç°

```bash
# éªŒè¯æ‰€æœ‰åŠŸèƒ½å®Œæ•´æ€§
python3 validate_implementation.py
```

åº”è¯¥çœ‹åˆ°æ‰€æœ‰é¡¹ç›®éƒ½æ˜¾ç¤º âœ“

### 3. å¼€å§‹è®­ç»ƒ

```bash
# æ¨èé…ç½®ï¼ˆåŒ…å«æ–°çš„æŸå¤±å‡½æ•°å’Œæ®‹å·®è®¾ç½®ï¼‰
python train_bubble_swinir.py \
    --epochs 500 \
    --curriculum_interval 10 \
    --checkpoint_interval 5 \
    --eval_interval 5 \
    --batch_size 16 \
    --augment \
    --multi_gpu True \
    --gpu_ids "2,3" \
    --lambda_l1 1.0 \
    --lambda_edge 10.0 \        # å¼ºè¾¹ç¼˜çº¦æŸ
    --lambda_ssim 1.0 \         # SSIMçº¦æŸ
    --lambda_gradient 5.0 \     # æ¢¯åº¦çº¦æŸ
    --lambda_perceptual 0.1 \
    --edge_method sobel \
    --residual_scale 0.5 \      # ç‰¹å¾çº§æ®‹å·®ï¼ˆæ¨è0.3-0.8ï¼‰
    --shallow_residual_scale 0.1  # å›¾åƒçº§æ®‹å·®ï¼ˆæ¨è0.0-0.2ï¼‰
```

### 4. ç›‘æ§è®­ç»ƒ

**æ–¹å¼1ï¼šæŸ¥çœ‹å®æ—¶è¾“å‡º**
ç»ˆç«¯ä¼šå®æ—¶æ˜¾ç¤ºæ¯ä¸ªiterationçš„è¯¦ç»†ä¿¡æ¯ã€‚

**æ–¹å¼2ï¼šæŸ¥çœ‹è®­ç»ƒæ›²çº¿**
```bash
# éšæ—¶æŸ¥çœ‹è®­ç»ƒæ›²çº¿
open experiments/<timestamp>/training_curves.png
```

**æ–¹å¼3ï¼šä½¿ç”¨TensorBoard**

**æœ¬åœ°è®­ç»ƒï¼ˆç›´æ¥è®¿é—®ï¼‰ï¼š**
```bash
tensorboard --logdir ./experiments/<timestamp>/logs --port 6006
# æ‰“å¼€æµè§ˆå™¨: http://localhost:6006
```

**è¿œç¨‹æœåŠ¡å™¨è®­ç»ƒï¼ˆSSHç«¯å£è½¬å‘ï¼‰ï¼š**

å¦‚æœè®­ç»ƒåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šï¼Œéœ€è¦é€šè¿‡SSHç«¯å£è½¬å‘å°†è¿œç¨‹TensorBoardæ˜ å°„åˆ°æœ¬åœ°ï¼š

```bash
# æ­¥éª¤1ï¼šåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šå¯åŠ¨TensorBoard
# SSHç™»å½•æœåŠ¡å™¨åæ‰§è¡Œï¼š
tensorboard --logdir ./experiments/<timestamp>/logs --port 6006 --bind_all

# æ­¥éª¤2ï¼šåœ¨æœ¬åœ°ç”µè„‘æ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œæ‰§è¡ŒSSHç«¯å£è½¬å‘
# è¯­æ³•ï¼šssh -L [æœ¬åœ°ç«¯å£]:localhost:[è¿œç¨‹ç«¯å£] [ç”¨æˆ·å]@[æœåŠ¡å™¨åœ°å€]
ssh -L 6006:localhost:6006 username@server_address

# ä¾‹å¦‚ï¼š
ssh -L 6006:localhost:6006 yubd@192.168.1.100

# æ­¥éª¤3ï¼šåœ¨æœ¬åœ°æµè§ˆå™¨è®¿é—®
# æ‰“å¼€æµè§ˆå™¨è®¿é—®: http://localhost:6006
```

**ä¸€æ­¥åˆ°ä½ï¼ˆæ¨èï¼‰ï¼š**
```bash
# åœ¨æœ¬åœ°ç”µè„‘ç›´æ¥æ‰§è¡ŒSSHè¿œç¨‹å‘½ä»¤ + ç«¯å£è½¬å‘
ssh -L 6006:localhost:6006 username@server_address \
    "cd /path/to/SwinIR && tensorboard --logdir ./experiments/<timestamp>/logs --port 6006"

# ç„¶ååœ¨æœ¬åœ°æµè§ˆå™¨è®¿é—®: http://localhost:6006
```

**ä¿æŒåå°è¿è¡Œï¼ˆä½¿ç”¨nohupï¼‰ï¼š**
```bash
# åœ¨æœåŠ¡å™¨ä¸Šåå°å¯åŠ¨TensorBoard
nohup tensorboard --logdir ./experiments/<timestamp>/logs --port 6006 --bind_all > tensorboard.log 2>&1 &

# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
tail -f tensorboard.log

# æœ¬åœ°ç”µè„‘æ‰§è¡Œç«¯å£è½¬å‘ï¼ˆä¿æŒæ­¤ç»ˆç«¯æ‰“å¼€ï¼‰
ssh -L 6006:localhost:6006 username@server_address

# è®¿é—® http://localhost:6006
```

**åœæ­¢TensorBoardï¼š**
```bash
# æŸ¥æ‰¾TensorBoardè¿›ç¨‹
ps aux | grep tensorboard

# ç»ˆæ­¢è¿›ç¨‹
kill <PID>
```

### 5. æµ‹è¯•æ¨¡å‹

```bash
python test_bubble_swinir.py \
    --test_root /path/to/dataset/test20251117 \
    --checkpoint experiments/<timestamp>/checkpoints/best_model.pth \
    --save_dir ./test_results \
    --img_size 128 \
    --in_chans 1
```

---

## ğŸ¨ åŠŸèƒ½ç‰¹æ€§

### æ•°æ®å¤„ç†

- âœ… **è‡ªåŠ¨å‘ç°ç±»åˆ«**: æ‰«ææ•°æ®é›†ç›®å½•ï¼Œè‡ªåŠ¨è¯†åˆ«æ‰€æœ‰é®æŒ¡ç±»åˆ«
- âœ… **è¯¾ç¨‹å­¦ä¹ è¿‡æ»¤**: `filtered_dataset()`æ–¹æ³•æ”¯æŒåŠ¨æ€ç±»åˆ«é€‰æ‹©
- âœ… **æ•°æ®å¢å¼º**: å¯é€‰çš„ç¿»è½¬ã€æ—‹è½¬ç­‰å¢å¼ºï¼ˆ`--augment`ï¼‰
- âœ… **LRUç¼“å­˜**: å›¾åƒåŠ è½½ç¼“å­˜ï¼Œæå‡è®­ç»ƒé€Ÿåº¦
- âœ… **çµæ´»æ ¼å¼**: æ”¯æŒæ‰å¹³å’ŒåµŒå¥—ç›®å½•ç»“æ„

### è®­ç»ƒç­–ç•¥

- âœ… **è¯¾ç¨‹å­¦ä¹ **: ä»ä½é®æŒ¡åˆ°é«˜é®æŒ¡çš„æ¸è¿›å¼è®­ç»ƒ
- âœ… **å¤šGPUå¹¶è¡Œ**: DataParallelæ”¯æŒï¼Œè‡ªåŠ¨è°ƒæ•´å‚æ•°
- âœ… **å­¦ä¹ ç‡ç­–ç•¥**: Warmup + ä½™å¼¦é€€ç«
- âœ… **æ¢¯åº¦è£å‰ª**: å¯é€‰çš„æ¢¯åº¦è£å‰ªé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸
- âœ… **æ„ŸçŸ¥æŸå¤±**: å¯é€‰çš„VGGæ„ŸçŸ¥æŸå¤±ï¼ˆ`--lambda_perceptual`ï¼‰
- âœ… **æ··åˆæŸå¤±**: L1 Loss + Perceptual Loss

### è¯„ä¼°ä¸å¯è§†åŒ–

- âœ… **å¤šç»´åº¦æŒ‡æ ‡**: L1, MSE, PSNR, SSIM
- âœ… **ä¸‰æ•°æ®é›†è¯„ä¼°**: Train/Val/Test
- âœ… **å®æ—¶è¿›åº¦æ˜¾ç¤º**: æ¯ä¸ªiterationçš„è¯¦ç»†ä¿¡æ¯
- âœ… **è®­ç»ƒæ›²çº¿**: è‡ªåŠ¨ç”Ÿæˆ4ä¸ªæŒ‡æ ‡çš„æ›²çº¿å›¾
- âœ… **TensorBoard**: å®Œæ•´çš„è®­ç»ƒæ—¥å¿—è®°å½•
- âœ… **æµ‹è¯•å¯è§†åŒ–**: è¾“å…¥|é¢„æµ‹|ç›®æ ‡æ‹¼æ¥å›¾

### å®éªŒç®¡ç†

- âœ… **æ—¶é—´æˆ³ç®¡ç†**: è‡ªåŠ¨åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„å®éªŒæ–‡ä»¶å¤¹
- âœ… **é…ç½®è®°å½•**: å®Œæ•´ä¿å­˜æ‰€æœ‰è®­ç»ƒå‚æ•°
- âœ… **å®šæœŸä¿å­˜**: æ¯Nä¸ªepochä¿å­˜checkpointï¼ˆé»˜è®¤5ï¼‰
- âœ… **æœ€ä½³æ¨¡å‹**: è‡ªåŠ¨ä¿å­˜éªŒè¯é›†PSNRæœ€ä¼˜æ¨¡å‹
- âœ… **æ–­ç‚¹ç»­è®­**: æ”¯æŒä»checkpointæ¢å¤è®­ç»ƒï¼ˆ`--resume`ï¼‰

---

## ğŸ“ æ–‡ä»¶ç»“æ„

### æ ¸å¿ƒå®ç°æ–‡ä»¶

```
SwinIR/
â”œâ”€â”€ bubble_swinir_dataset.py       # æ•°æ®é›†åŠ è½½å™¨ï¼ˆæ”¯æŒDeepfillv2æ ¼å¼å’Œè¯¾ç¨‹å­¦ä¹ ï¼‰
â”œâ”€â”€ train_bubble_swinir.py         # è®­ç»ƒè„šæœ¬ï¼ˆå®Œæ•´è®­ç»ƒæµç¨‹ + æ–°åŠŸèƒ½ï¼‰
â”œâ”€â”€ test_bubble_swinir.py          # æµ‹è¯•è„šæœ¬ï¼ˆå®Œæ•´è¯„ä¼° + å¯è§†åŒ–ï¼‰
â”œâ”€â”€ validate_implementation.py     # å®ç°éªŒè¯è„šæœ¬
â””â”€â”€ models/
    â””â”€â”€ network_swinir.py          # SwinIRç½‘ç»œå®šä¹‰ï¼ˆåŸå§‹ï¼‰
```

### æ–‡æ¡£æ–‡ä»¶

### å®éªŒè¾“å‡º

```
experiments/
â””â”€â”€ 20251119_143025/               # æ—¶é—´æˆ³æ–‡ä»¶å¤¹
    â”œâ”€â”€ config.txt                 # è®­ç»ƒé…ç½®
    â”œâ”€â”€ training_curves.png        # è®­ç»ƒæ›²çº¿å›¾
    â”œâ”€â”€ checkpoints/
    â”‚   â”œâ”€â”€ epoch_0005.pth
    â”‚   â”œâ”€â”€ epoch_0010.pth
    â”‚   â””â”€â”€ best_model.pth
    â”œâ”€â”€ visualizations/
    â”‚   â”œâ”€â”€ epoch_0005/
    â”‚   â””â”€â”€ epoch_0010/
    â””â”€â”€ logs/
        â””â”€â”€ events.out.tfevents...
```

---

## âš™ï¸ å…³é”®å‚æ•°è¯´æ˜

### å¿…éœ€å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--train_root` | str | training_dataset20251111 | è®­ç»ƒé›†æ ¹ç›®å½• |
| `--val_root` | str | val | éªŒè¯é›†æ ¹ç›®å½• |
| `--test_root` | str | test20251117 | æµ‹è¯•é›†æ ¹ç›®å½• |

### è¯¾ç¨‹å­¦ä¹ å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--curriculum_interval` | int | 10 | æ¯Nä¸ªepochå¢åŠ ä¸€ä¸ªé®æŒ¡ç±»åˆ« |
| `--disable_curriculum` | flag | False | ç¦ç”¨è¯¾ç¨‹å­¦ä¹ ï¼Œä½¿ç”¨æ‰€æœ‰ç±»åˆ« |

### å¤šGPUè®­ç»ƒå‚æ•°ï¼ˆæ–°å¢ï¼‰

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--multi_gpu` | bool | True | æ˜¯å¦å¯ç”¨å¤šGPUå¹¶è¡Œè®­ç»ƒ |
| `--gpu_ids` | str | "2,3" | ä½¿ç”¨çš„GPU IDï¼ˆå¦‚"0,1,2"ï¼‰ |

### è®­ç»ƒå‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--epochs` | int | 500 | è®­ç»ƒæ€»è½®æ•° |
| `--batch_size` | int | 16 | å•GPUçš„batch sizeï¼ˆå¤šGPUæ—¶è‡ªåŠ¨Ã—Nï¼‰ |
| `--lr` | float | 2e-4 | å­¦ä¹ ç‡ |
| `--warmup_epochs` | int | 10 | Warmupè½®æ•° |
| `--augment` | flag | False | å¯ç”¨æ•°æ®å¢å¼º |

### æ®‹å·®è¿æ¥å‚æ•°ï¼ˆæ–°å¢ 2025-11-20ï¼‰

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--residual_scale` | float | 0.5 | ç‰¹å¾çº§æ®‹å·®ç³»æ•°ï¼ˆæ§åˆ¶x_firstä¿ç•™æ¯”ä¾‹ï¼‰ï¼šè¾ƒæ·±å±‚ï¼Œæ¨è0.3-0.8 |
| `--shallow_residual_scale` | float | 0.1 | å›¾åƒçº§æ®‹å·®ç³»æ•°ï¼ˆæ§åˆ¶xä¿ç•™æ¯”ä¾‹ï¼‰ï¼šæœ€æµ…å±‚ï¼Œæ¨è0.0-0.2 |

**æ¨èé…ç½®**ï¼ˆæŒ‰ä»»åŠ¡ç±»å‹ï¼‰ï¼š
- **å›¾åƒä¿®å¤/ä¼ªå½±æ¶ˆé™¤**ï¼ˆé»˜è®¤ï¼‰ï¼š`--residual_scale 0.5 --shallow_residual_scale 0.1`
- **æ¿€è¿›å†…å®¹è½¬æ¢**ï¼š`--residual_scale 0.3 --shallow_residual_scale 0.0`
- **ä¿å®ˆä¿®å¤**ï¼ˆè®­ç»ƒä¸ç¨³å®šæ—¶ï¼‰ï¼š`--residual_scale 0.8 --shallow_residual_scale 0.2`

### æŸå¤±å‡½æ•°å‚æ•°ï¼ˆæ–°å¢ï¼‰

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--lambda_l1` | float | 1.0 | L1 lossæƒé‡ |
| `--lambda_edge` | float | 5.0 | è¾¹ç¼˜æŸå¤±æƒé‡ï¼ˆæ¨è5-10ï¼‰ |
| `--lambda_ssim` | float | 1.0 | SSIMæŸå¤±æƒé‡ï¼ˆæ¨è1-2ï¼‰ |
| `--lambda_gradient` | float | 2.0 | æ¢¯åº¦æŸå¤±æƒé‡ï¼ˆæ¨è2-5ï¼‰ |
| `--lambda_perceptual` | float | 0.1 | æ„ŸçŸ¥æŸå¤±æƒé‡ |
| `--edge_method` | str | 'sobel' | è¾¹ç¼˜æ£€æµ‹æ–¹æ³•ï¼ˆsobel/cannyï¼‰ |

**æ¨èé…ç½®**ï¼š
- å¼ºè¾¹ç¼˜çº¦æŸï¼š`--lambda_edge 10.0 --lambda_ssim 1.0 --lambda_gradient 5.0`
- å¹³è¡¡é…ç½®ï¼š`--lambda_edge 5.0 --lambda_ssim 1.5 --lambda_gradient 2.0`
- ä»…è¾¹ç¼˜+SSIMï¼š`--lambda_edge 8.0 --lambda_ssim 2.0 --lambda_gradient 0.0`

### è¯„ä¼°å’Œä¿å­˜å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--checkpoint_interval` | int | 5 | æ¯Nä¸ªepochä¿å­˜checkpoint |
| `--eval_interval` | int | 5 | æ¯Nä¸ªepochåœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°ï¼ˆå¹¶æ›´æ–°æ›²çº¿ï¼‰ |

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¸Deepfillv2å¯¹æ¯”

| ç»´åº¦ | Deepfillv2 | SwinIR (æœ¬é¡¹ç›®) |
|------|-----------|----------------|
| **æ¶æ„** | CNN (Gated Convolution) | Transformer (Swin) |
| **å…¨å±€å»ºæ¨¡** | æœ‰é™ | âœ… ä¼˜ç§€ï¼ˆè‡ªæ³¨æ„åŠ›ï¼‰ |
| **è¾“å…¥** | å›¾åƒ + æ©ç  | ä»…å›¾åƒï¼ˆæ— éœ€æ©ç ï¼‰ |
| **è¯¾ç¨‹å­¦ä¹ ** | âœ… æ”¯æŒ | âœ… å®Œå…¨ç»§æ‰¿ |
| **å‚æ•°é‡** | ~20M | ~15M |
| **è®­ç»ƒé€Ÿåº¦** | è¾ƒå¿« | ä¸­ç­‰ |
| **å¤šGPUæ”¯æŒ** | âœ… æ”¯æŒ | âœ… æ”¯æŒï¼ˆæ–°å¢ï¼‰ |
| **å®æ—¶è¿›åº¦** | âœ… æ”¯æŒ | âœ… æ”¯æŒï¼ˆæ–°å¢ï¼‰ |
| **è®­ç»ƒæ›²çº¿** | âŒ æ—  | âœ… æ”¯æŒï¼ˆæ–°å¢ï¼‰ |

### é¢„æœŸæ€§èƒ½åŸºçº¿

| æŒ‡æ ‡ | åŸºæœ¬å¯ç”¨ | è¾ƒå¥½ | ä¼˜ç§€ |
|------|---------|------|------|
| **PSNR** | >25 dB | >28 dB | >30 dB |
| **SSIM** | >0.80 | >0.85 | >0.90 |

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### 1. è‡ªå®šä¹‰è¯¾ç¨‹å­¦ä¹ é€Ÿåº¦

```bash
# æ…¢é€Ÿè¯¾ç¨‹ï¼ˆæ›´ç»†è‡´ï¼‰
python train_bubble_swinir.py --curriculum_interval 15

# å¿«é€Ÿè¯¾ç¨‹ï¼ˆæ›´æ¿€è¿›ï¼‰
python train_bubble_swinir.py --curriculum_interval 5

# ç¦ç”¨è¯¾ç¨‹å­¦ä¹ 
python train_bubble_swinir.py --disable_curriculum
```

### 2. è°ƒæ•´æ¨¡å‹å¤§å°

```bash
# å°æ¨¡å‹ï¼ˆæ•°æ®é›†<2000æ ·æœ¬ï¼‰
python train_bubble_swinir.py \
    --embed_dim 60 \
    --depths 4 4 4 4 \
    --num_heads 4 4 4 4

# å¤§æ¨¡å‹ï¼ˆæ•°æ®é›†>5000æ ·æœ¬ï¼‰
python train_bubble_swinir.py \
    --embed_dim 180 \
    --depths 6 6 6 6 6 6 \
    --num_heads 6 6 6 6 6 6
```

### 3. æ¢å¤è®­ç»ƒ

```bash
python train_bubble_swinir.py \
    --resume experiments/20251119_143025/checkpoints/epoch_0100.pth \
    --epochs 1000
```

### 4. å•GPUè®­ç»ƒ

```bash
python train_bubble_swinir.py --multi_gpu False
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: è®­ç»ƒä¸æ”¶æ•›æ€ä¹ˆåŠï¼Ÿ

1. é™ä½å­¦ä¹ ç‡: `--lr 1e-4`
2. å¢åŠ warmup: `--warmup_epochs 20`
3. å‡æ…¢è¯¾ç¨‹å­¦ä¹ : `--curriculum_interval 15`
4. ç¦ç”¨perceptual loss: `--lambda_perceptual 0`

### Q2: æ˜¾å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿ

1. å‡å°batch size: `--batch_size 8`
2. å‡å°æ¨¡å‹: `--embed_dim 60`
3. ç¦ç”¨å¤šGPU: `--multi_gpu False`
4. å‡å°‘workers: `--num_workers 2`

### Q3: å¦‚ä½•æŒ‡å®šç‰¹å®šGPUï¼Ÿ

```bash
# ä½¿ç”¨GPU 2å’Œ3
python train_bubble_swinir.py --gpu_ids "2,3"

# ä½¿ç”¨GPU 0ã€1ã€2ã€3
python train_bubble_swinir.py --gpu_ids "0,1,2,3"
```

### Q4: è®­ç»ƒæ›²çº¿æ²¡æœ‰ç”Ÿæˆï¼Ÿ

æ£€æŸ¥ï¼š
1. matplotlibæ˜¯å¦å®‰è£…ï¼š`pip install matplotlib`
2. ä¿å­˜ç›®å½•æƒé™
3. æ˜¯å¦è¿è¡Œäº†è‡³å°‘1ä¸ªepoch

---

## ğŸ“œ æ›´æ–°å†å²

### 2025-11-20 - æ®‹å·®è¿æ¥é‡å¤§ä¿®æ­£

**å…³é”®ä¿®å¤**:
1. ğŸ”§ **ä¿®æ­£æ®‹å·®è¿æ¥è¯­ä¹‰æ··ä¹±é—®é¢˜**
   - ä¿®æ­£`residual_scale`å’Œ`shallow_residual_scale`å‚æ•°çš„ä½œç”¨å¯¹è±¡
   - ç»Ÿä¸€æ®‹å·®è¿æ¥é€»è¾‘ï¼šç³»æ•°éƒ½ä½œç”¨åœ¨"æ—§çš„/è¾“å…¥"ä¸Š
   - æ­£ç¡®å®ç°"è¶Šé è¿‘è¾“å…¥è¾“å‡ºï¼Œæ®‹å·®æ¯”ä¾‹è¶Šå°"çš„è®¾è®¡ç†å¿µ

2. âœ¨ **æ®‹å·®å‚æ•°è¶…å‚æ•°åŒ–**
   - å°†æ®‹å·®å‚æ•°æ·»åŠ åˆ°å‘½ä»¤è¡Œå‚æ•°ï¼ˆ`--residual_scale`, `--shallow_residual_scale`ï¼‰
   - æ”¯æŒçµæ´»è°ƒæ•´ï¼Œæ–¹ä¾¿å®éªŒå¯¹æ¯”
   - æ›´æ–°é»˜è®¤å€¼ï¼š`residual_scale=0.5`, `shallow_residual_scale=0.1`

3. ğŸ“š **å®Œå–„æ–‡æ¡£**
   - æ·»åŠ TensorBoardè¿œç¨‹è®¿é—®è¯¦ç»†æ•™ç¨‹ï¼ˆSSHç«¯å£è½¬å‘ï¼‰
   - æ›´æ–°æ®‹å·®è¿æ¥è®¾è®¡æ€è·¯å’Œæ•°æ®æµå¯è§†åŒ–
   - æ·»åŠ è°ƒå‚ç­–ç•¥å’Œåˆ¤æ–­æ ‡å‡†

**ä»£ç ä¿®æ”¹**:
```python
# ä¿®æ”¹å‰ï¼ˆé”™è¯¯é€»è¾‘ï¼‰ï¼š
res = conv_after_body(features) + shallow_residual_scale * x_first  # âŒ å‚æ•°åäº†
output = x + residual_scale * conv_last(res)                         # âŒ ç³»æ•°ä½œç”¨åœ¨è¾“å‡º

# ä¿®æ”¹åï¼ˆæ­£ç¡®é€»è¾‘ï¼‰ï¼š
res = conv_after_body(features) + residual_scale * x_first          # âœ… æ§åˆ¶è¾ƒæ·±å±‚
output = conv_last(res) + shallow_residual_scale * x                 # âœ… æ§åˆ¶æœ€æµ…å±‚
```

### 2025-11-19 - æ¶æ„çº§ä¼˜åŒ–ï¼ˆé‡å¤§æ›´æ–°ï¼‰

**æ–°å¢åŠŸèƒ½**:
1. âœ¨ **å¢å¼ºçš„æŸå¤±å‡½æ•°ç³»ç»Ÿ**
   - EdgeLossï¼ˆè¾¹ç¼˜æŸå¤±ï¼‰ï¼šå¼•å¯¼ç”Ÿæˆæ¸…æ™°çš„å•æ°”æ³¡è½®å»“
   - SSIMLossï¼ˆç»“æ„ç›¸ä¼¼æ€§ï¼‰ï¼šä¿æŒæ•´ä½“ç»“æ„ä¸€è‡´æ€§
   - GradientLossï¼ˆæ¢¯åº¦æŸå¤±ï¼‰ï¼šä¿æŒè¾¹ç¼˜é”åˆ©åº¦
   - 5ç§æŸå¤±å‡½æ•°ç»„åˆï¼Œä¸“é—¨é’ˆå¯¹å†…å®¹è½¬æ¢ä»»åŠ¡

2. âœ¨ **å¯æ§çš„æ®‹å·®è¿æ¥**ï¼ˆåˆç‰ˆï¼‰
   - æ·»åŠ `residual_scale`å’Œ`shallow_residual_scale`å‚æ•°
   - è§£å†³SwinIRä¸é€‚åˆå†…å®¹è½¬æ¢ä»»åŠ¡çš„æ ¸å¿ƒé—®é¢˜
   - *æ³¨ï¼šå‚æ•°è¯­ä¹‰åœ¨2025-11-20ä¿®æ­£*

3. âœ¨ **å¤šGPUå¹¶è¡Œè®­ç»ƒ** - DataParallelæ”¯æŒï¼Œè‡ªåŠ¨ä¼˜åŒ–
4. âœ¨ **å®æ—¶è®­ç»ƒè¿›åº¦æ˜¾ç¤º** - æ¯ä¸ªiterationçš„è¯¦ç»†ä¿¡æ¯
5. âœ¨ **è®­ç»ƒæ›²çº¿å¯è§†åŒ–** - 4ä¸ªå­å›¾ï¼Œ3æ¡æ›²çº¿ï¼Œè‡ªåŠ¨æ›´æ–°

**æŠ€æœ¯æ”¹è¿›**:
- ä¿®æ”¹`models/network_swinir.py`ï¼šæ·»åŠ å¯æ§æ®‹å·®å‚æ•°
- ä¿®æ”¹`train_bubble_swinir.py`ï¼šé›†æˆæ–°æŸå¤±å‡½æ•°å’Œæ®‹å·®é…ç½®
- æ·»åŠ 4ä¸ªæ–°çš„æŸå¤±å‡½æ•°ç±»ï¼šEdgeLoss, SSIMLoss, GradientLoss
- æ·»åŠ `format_training_status()`å’Œ`plot_metrics()`å‡½æ•°

**ç†è®ºçªç ´**:
- è¯†åˆ«å¹¶è§£å†³äº†SwinIRçš„å½’çº³åç½®é—®é¢˜ï¼ˆæ®‹å·®è¿æ¥å¼ºåˆ¶ä¿ç•™è¾“å…¥ï¼‰
- é€šè¿‡å¯æ§æ®‹å·®å®ç°äº†ä»å›¾åƒæ¢å¤åˆ°å†…å®¹è½¬æ¢çš„æ¶æ„é€‚é…
- SwinIR vs U-Netæ®‹å·®è¿æ¥å¯¹æ¯”åˆ†æ

### 2025-11-17 - åˆå§‹ç‰ˆæœ¬

**æ ¸å¿ƒåŠŸèƒ½**:
1. âœ… è¯¾ç¨‹å­¦ä¹ ï¼ˆé®æŒ¡ç¨‹åº¦æ¸è¿›å¼è®­ç»ƒï¼‰
2. âœ… ç›´æ¥ä½¿ç”¨Deepfillv2æ•°æ®æ ¼å¼
3. âœ… å®Œæ•´è¯„ä¼°æŒ‡æ ‡ï¼ˆL1, MSE, PSNR, SSIMï¼‰
4. âœ… æµ‹è¯•é›†å®šæœŸè¯„ä¼°å’Œå¯è§†åŒ–
5. âœ… æ—¶é—´æˆ³å®éªŒæ–‡ä»¶å¤¹ç®¡ç†
6. âœ… å®šæœŸcheckpointä¿å­˜

---

## ğŸ™ è‡´è°¢

æœ¬é¡¹ç›®åŸºäºä»¥ä¸‹å·¥ä½œï¼š

1. **[SwinIR (ICCV 2021)](https://github.com/JingyunLiang/SwinIR)** by Jingyun Liang et al.
   - Swin Transformeræ¶æ„
   - å›¾åƒæ¢å¤åŸºç¡€æ¡†æ¶

2. **Deepfillv2**
   - è¯¾ç¨‹å­¦ä¹ ç­–ç•¥
   - æ°”æ³¡æ•°æ®é›†æ ¼å¼
   - å®æ—¶è¿›åº¦æ˜¾ç¤ºè®¾è®¡

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªApache 2.0è®¸å¯è¯ã€‚è¯¦è§[LICENSE](LICENSE)ã€‚

**åŸå§‹SwinIR**éµå¾ªApache 2.0è®¸å¯è¯ã€‚

---

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- Issue: åœ¨æœ¬ä»“åº“åˆ›å»ºIssue
- Email: [æ‚¨çš„é‚®ç®±]

---

## ğŸ”— ç›¸å…³é“¾æ¥

- **åŸå§‹SwinIR**: https://github.com/JingyunLiang/SwinIR
- **SwinIRè®ºæ–‡**: https://arxiv.org/abs/2108.10257
- **è®­ç»ƒä»£ç å‚è€ƒ**: https://github.com/cszn/KAIR

---

## ğŸ“Œ åŸå§‹SwinIR

<details>
<summary>ç‚¹å‡»å±•å¼€åŸå§‹SwinIRä¿¡æ¯</summary>

### SwinIR: Image Restoration Using Swin Transformer

**ä½œè€…**: Jingyun Liang, Jiezhang Cao, Guolei Sun, Kai Zhang, Luc Van Gool, Radu Timofte

**æœºæ„**: Computer Vision Lab, ETH Zurich

**è®ºæ–‡**: [arXiv](https://arxiv.org/abs/2108.10257)

**åŸå§‹åº”ç”¨**:
- å›¾åƒè¶…åˆ†è¾¨ç‡ï¼ˆClassical/Lightweight/Real-Worldï¼‰
- å›¾åƒå»å™ªï¼ˆGrayscale/Colorï¼‰
- JPEGå‹ç¼©ä¼ªå½±å»é™¤

**æ¶æ„ç‰¹ç‚¹**:
- åŸºäºSwin Transformerçš„æ®‹ä½™æ¨¡å—ï¼ˆRSTBï¼‰
- æµ…å±‚ç‰¹å¾æå– + æ·±å±‚ç‰¹å¾æå– + é«˜è´¨é‡é‡å»º
- å‚æ•°é‡å¯å‡å°‘67%ï¼Œæ€§èƒ½æå‡0.14~0.45dB

**é¢„è®­ç»ƒæ¨¡å‹**: https://github.com/JingyunLiang/SwinIR/releases

</details>

---

**æœ€åæ›´æ–°**: 2025-11-20
**ç‰ˆæœ¬**: 2.1
**ç»´æŠ¤è€…**: [æ‚¨çš„åå­—]
